package gildasai

import (
	"image"
	"testing"

	"github.com/gildasch/gildas-ai/imageutils"
	"github.com/pkg/errors"
	"github.com/stretchr/testify/require"
)

type mockDetector struct {
	detect [][]Detection
}

func (m *mockDetector) Detect(img image.Image) ([]Detection, error) {
	if len(m.detect) == 0 {
		return nil, errors.New("no more detect available")
	}
	defer func() { m.detect = m.detect[1:] }()

	return m.detect[0], nil
}

type mockLandmark struct {
	landmarks []*Landmarks
}

func (m *mockLandmark) Detect(img image.Image) (*Landmarks, error) {
	if len(m.landmarks) == 0 {
		return nil, errors.New("no more landmarks available")
	}
	defer func() { m.landmarks = m.landmarks[1:] }()

	return m.landmarks[0], nil
}

func TestFaceSwap(t *testing.T) {
	src, err := imageutils.FromFile("testdata/gab.png")
	require.NoError(t, err)
	dest, err := imageutils.FromFile("testdata/group.jpg")
	require.NoError(t, err)

	detector := &mockDetector{
		detect: [][]Detection{
			detectResults["gab.png"],
			detectResults["group.jpg"]},
	}

	landmarkRes := append(
		landmarkResults["gab.png"],
		landmarkResults["group.jpg"]...)
	for i := 0; i < len(landmarkResults["group.jpg"]); i++ {
		landmarkRes = append(landmarkRes, landmarkResults["gab.png"][0], landmarkResults["group.jpg"][i])
	}

	landmark := &mockLandmark{
		landmarks: landmarkRes,
	}

	extractor := &Extractor{
		Detector: detector,
		Landmark: landmark,
	}

	out, err := FaceSwap(extractor, landmark, dest, src, 0)
	require.NoError(t, err)

	imageutils.AssertImageEqual(t, "testdata/faceswap-expected.png", out)
}

func TestSwap(t *testing.T) {
	src, err := imageutils.FromFile("testdata/gab.png")
	require.NoError(t, err)
	dest, err := imageutils.FromFile("testdata/syl.png")
	require.NoError(t, err)

	landmark := &mockLandmark{
		landmarks: append(landmarkResults["gab.png-2"],
			landmarkResults["syl.png"]...),
	}

	out, err := swap(landmark, src, dest, 0)
	require.NoError(t, err)

	imageutils.AssertImageEqual(t, "testdata/swap-expected.png", out)
}

func TestMaskFromPolygon(t *testing.T) {
	in := image.NewRGBA(image.Rectangle{
		Max: image.Point{100, 100},
	})
	mask := maskFromPolygon(in, []image.Point{
		{10, 10}, {5, 65}, {17, 85}, {45, 66}, {70, 70}, {60, 30}, {50, 15},
	})

	imageutils.AssertImageEqual(t, "testdata/maskFromPolygon-expected.png", mask)
}

func TestMaskFromPolygonWithBounds(t *testing.T) {
	in := image.NewRGBA(image.Rectangle{
		Min: image.Point{100, 100},
		Max: image.Point{200, 200},
	})
	mask := maskFromPolygon(in, []image.Point{
		{110, 110}, {105, 165}, {117, 185}, {145, 166}, {170, 170}, {160, 130}, {150, 115},
	})

	imageutils.AssertImageEqual(t, "testdata/maskFromPolygonWithBounds-expected.png", mask)
}

var detectResults = map[string][]Detection{
	"gab.png": []Detection{
		{Box: image.Rect(36, 55, 181, 281), Score: 0.9171224, Class: 1}},
	"group.jpg": []Detection{
		{Box: image.Rect(1462, 247, 1747, 591), Score: 0.98201764, Class: 1},
		{Box: image.Rect(3250, 355, 3525, 700), Score: 0.9507992, Class: 1},
		{Box: image.Rect(766, 436, 1155, 909), Score: 0.83032966, Class: 1},
		{Box: image.Rect(2003, 398, 2234, 699), Score: 0.58623713, Class: 1},
		{Box: image.Rect(3715, 484, 4191, 933), Score: 0.5553559, Class: 1}},
}

var landmarkResults = map[string][]*Landmarks{
	"gab.png": []*Landmarks{
		{Coords: []float32{0.06259745, 0.40469998, 0.078198574, 0.5164092, 0.1044285, 0.61961085, 0.13482371, 0.7066827, 0.1797969, 0.7937511, 0.25212687, 0.8498771, 0.3362134, 0.88448066, 0.4412148, 0.91867006, 0.57552934, 0.93553233, 0.70269567, 0.9076463, 0.78441733, 0.8751498, 0.8502034, 0.8426403, 0.9090108, 0.7772871, 0.95175683, 0.68899715, 0.968125, 0.59996974, 0.9849155, 0.50530803, 0.98555446, 0.40381292, 0.18362749, 0.31144905, 0.24622586, 0.28320664, 0.32152447, 0.2688669, 0.39089966, 0.2666525, 0.4531357, 0.28443336, 0.66798055, 0.28485185, 0.7262411, 0.26747817, 0.7877954, 0.26400685, 0.8620364, 0.27643624, 0.9142046, 0.3034777, 0.56333584, 0.35558343, 0.56954193, 0.40514344, 0.5748342, 0.45487761, 0.57365274, 0.5087948, 0.49370694, 0.55577844, 0.5291795, 0.564836, 0.57011247, 0.57039416, 0.61059433, 0.56016594, 0.6445861, 0.5553051, 0.27944514, 0.36907774, 0.32444358, 0.35067368, 0.38108605, 0.34612805, 0.4313059, 0.36839426, 0.38985872, 0.38709426, 0.32848668, 0.38687885, 0.6788616, 0.36650336, 0.7300521, 0.3397466, 0.7887254, 0.34388798, 0.82621276, 0.3691778, 0.78602314, 0.38465005, 0.727229, 0.37633893, 0.39056873, 0.6878975, 0.45573944, 0.64998585, 0.53497964, 0.6258979, 0.5726751, 0.63241124, 0.6083087, 0.62317985, 0.6846528, 0.65030724, 0.73936754, 0.68615913, 0.6801343, 0.72693855, 0.63049173, 0.7476059, 0.57359815, 0.7548964, 0.5216634, 0.7504673, 0.45951447, 0.73233986, 0.40117154, 0.68832314, 0.5173968, 0.66165197, 0.572376, 0.662433, 0.6242744, 0.6645684, 0.7244116, 0.68428946, 0.6247437, 0.70125556, 0.5742726, 0.70537305, 0.5222851, 0.7038401}},
	},
	"group.jpg": []*Landmarks{
		{Coords: []float32{0.04401797, 0.2920624, 0.041536488, 0.41880652, 0.050311077, 0.53846955, 0.06450743, 0.64459205, 0.09430371, 0.7618832, 0.16262503, 0.851789, 0.25675637, 0.91328454, 0.37437844, 0.9760077, 0.51951295, 1.0194257, 0.6597049, 1.0001124, 0.73600256, 0.96718466, 0.8018121, 0.92958105, 0.8645844, 0.8508117, 0.9197382, 0.7434193, 0.95210385, 0.64309, 0.9761915, 0.54299927, 0.9811871, 0.43174496, 0.23013192, 0.19723302, 0.3093028, 0.17346866, 0.3925455, 0.17222491, 0.46253568, 0.18838635, 0.521562, 0.2165105, 0.742101, 0.25015962, 0.7987384, 0.23900086, 0.8572351, 0.24123766, 0.9197172, 0.25878865, 0.9540974, 0.2970405, 0.62032926, 0.3298666, 0.6271931, 0.39310634, 0.6329008, 0.4512954, 0.627414, 0.5119134, 0.51354337, 0.56119347, 0.55396235, 0.5775431, 0.597433, 0.5873404, 0.64092445, 0.5832027, 0.67212117, 0.5822062, 0.31484792, 0.29128495, 0.3708399, 0.28156522, 0.43034756, 0.28579965, 0.47399622, 0.3197651, 0.43247598, 0.3315928, 0.36603686, 0.32106748, 0.71644926, 0.35411438, 0.77301276, 0.33317235, 0.8341036, 0.34362793, 0.859087, 0.37246883, 0.82303464, 0.38580137, 0.7645813, 0.37153995, 0.35876957, 0.70278364, 0.45132092, 0.67293125, 0.54731786, 0.65776575, 0.5890691, 0.66927993, 0.62699556, 0.6644777, 0.70069635, 0.70057833, 0.7432704, 0.74534416, 0.6811846, 0.7793629, 0.62799746, 0.7947775, 0.568006, 0.7966863, 0.5092913, 0.783159, 0.44147944, 0.75690097, 0.36965525, 0.7037538, 0.51605, 0.696163, 0.57992715, 0.7041592, 0.6342912, 0.7123858, 0.7285031, 0.74125063, 0.63015234, 0.7424253, 0.5756346, 0.7408873, 0.5172279, 0.7336909}},
		{Coords: []float32{0.042623054, 0.49933276, 0.05878957, 0.5952669, 0.08569466, 0.6833858, 0.12724529, 0.7606633, 0.1818431, 0.8499347, 0.24745741, 0.9136888, 0.30940554, 0.95313835, 0.38454503, 0.9982595, 0.513531, 1.0121591, 0.6429833, 0.9539188, 0.7473073, 0.8844672, 0.82714605, 0.82072514, 0.8914305, 0.7313234, 0.9243405, 0.63034034, 0.9271319, 0.5325623, 0.9256201, 0.4253915, 0.9112879, 0.30790403, 0.046376243, 0.3809035, 0.07394844, 0.34416354, 0.116788834, 0.32137054, 0.16632016, 0.31397152, 0.21358678, 0.3226959, 0.40847805, 0.2808878, 0.4565229, 0.25242186, 0.5230905, 0.23079628, 0.6066938, 0.22973013, 0.6841315, 0.2454338, 0.32519954, 0.39748943, 0.3244735, 0.45990664, 0.31987455, 0.5123901, 0.32122666, 0.56566656, 0.30662543, 0.6214479, 0.32983726, 0.6243069, 0.36725587, 0.62359726, 0.41130427, 0.6057981, 0.44566816, 0.59171915, 0.13693592, 0.43995512, 0.15758857, 0.42265582, 0.20519389, 0.4100879, 0.25911996, 0.42105013, 0.21946324, 0.4449932, 0.16966568, 0.45142734, 0.4640793, 0.3733161, 0.5031516, 0.34214935, 0.55386484, 0.33491662, 0.6075828, 0.34272826, 0.56412274, 0.36795574, 0.50765425, 0.37458557, 0.29181966, 0.78519344, 0.29914382, 0.7254351, 0.34905833, 0.6860953, 0.38662934, 0.68381274, 0.4217912, 0.6680737, 0.5211706, 0.6857454, 0.6095099, 0.72453964, 0.55541813, 0.81748855, 0.5035857, 0.8662245, 0.44260082, 0.88889015, 0.39043584, 0.8903161, 0.33942842, 0.8616308, 0.29765832, 0.78365093, 0.35117102, 0.72269136, 0.3979019, 0.7108746, 0.45688528, 0.70578057, 0.5991676, 0.7259787, 0.4865557, 0.8208107, 0.43391302, 0.84126765, 0.3846457, 0.841631}},
		{Coords: []float32{0.05283252, 0.41299814, 0.072331384, 0.5407791, 0.09960882, 0.65858597, 0.13301228, 0.7540544, 0.1903274, 0.85445076, 0.28314114, 0.9184964, 0.39488184, 0.9559334, 0.5272466, 0.98535776, 0.67309874, 1.0029725, 0.79377747, 0.9759687, 0.8438307, 0.9477891, 0.8862536, 0.9226526, 0.9267617, 0.8524271, 0.9610336, 0.7541798, 0.97337496, 0.65629756, 0.9778844, 0.55634904, 0.96902263, 0.44806933, 0.26975718, 0.2914654, 0.34991536, 0.257458, 0.435894, 0.24626884, 0.5074607, 0.25356233, 0.56948674, 0.2753929, 0.77971953, 0.289558, 0.83058643, 0.27329582, 0.8823221, 0.27083984, 0.93729794, 0.28361514, 0.9634576, 0.31488532, 0.6813187, 0.38402408, 0.70361173, 0.4502485, 0.72726905, 0.5144776, 0.7295391, 0.57894117, 0.6187496, 0.6334098, 0.6609525, 0.6418759, 0.70208776, 0.64980435, 0.73975086, 0.63887495, 0.7632711, 0.6363184, 0.36853147, 0.37248152, 0.42682564, 0.35650983, 0.4816833, 0.35646328, 0.5244963, 0.38387793, 0.4912516, 0.40243137, 0.42671493, 0.39749825, 0.76025534, 0.39509588, 0.81199116, 0.37092245, 0.86850345, 0.37562615, 0.887418, 0.39902103, 0.86029637, 0.41596255, 0.8071066, 0.40938243, 0.52020997, 0.7790246, 0.6002102, 0.74759734, 0.6753092, 0.7245198, 0.7080837, 0.73286796, 0.7407845, 0.7235202, 0.7964988, 0.7528827, 0.8328073, 0.7821579, 0.7899879, 0.79270214, 0.75184906, 0.8037781, 0.70596755, 0.8088198, 0.65959156, 0.8039356, 0.5985044, 0.7930651, 0.5298621, 0.77760285, 0.64914346, 0.76139903, 0.7013116, 0.7640995, 0.74413806, 0.7673295, 0.820467, 0.7782644, 0.74741566, 0.75901926, 0.70620275, 0.758044, 0.6585711, 0.7573978}},
		{Coords: []float32{0.10250776, 0.47882915, 0.12810233, 0.5951747, 0.15921478, 0.69862413, 0.19631436, 0.786309, 0.25847197, 0.8726666, 0.34963042, 0.92572635, 0.4603317, 0.95332766, 0.580214, 0.98046637, 0.70843226, 0.98869765, 0.8060988, 0.95272994, 0.8419758, 0.90774393, 0.87631136, 0.86813354, 0.91097355, 0.7968179, 0.9434596, 0.7126852, 0.9558751, 0.6291565, 0.9567384, 0.5441957, 0.9349388, 0.45223305, 0.32154852, 0.37837744, 0.39478135, 0.34086192, 0.47593927, 0.3209753, 0.5450498, 0.31848922, 0.6063343, 0.33435738, 0.7802386, 0.32235336, 0.8234514, 0.3012488, 0.8642819, 0.29111046, 0.91315556, 0.2996139, 0.9312087, 0.3288088, 0.7071359, 0.43245173, 0.7344998, 0.49859983, 0.76225615, 0.55884385, 0.76821375, 0.62074625, 0.6562089, 0.6607194, 0.69766665, 0.6718704, 0.73599714, 0.6784737, 0.76942766, 0.66060925, 0.78881186, 0.6519416, 0.4242978, 0.4435567, 0.47645164, 0.4261989, 0.5264793, 0.4203943, 0.56238145, 0.44208527, 0.53624356, 0.46237046, 0.4783948, 0.4625286, 0.76115775, 0.42960137, 0.80766076, 0.39937645, 0.85999745, 0.4000643, 0.87296414, 0.41845274, 0.8521199, 0.44059694, 0.8071332, 0.43612877, 0.533449, 0.76276404, 0.62289214, 0.74781394, 0.70255715, 0.7326238, 0.7345737, 0.73901165, 0.7638711, 0.7290903, 0.8096534, 0.7376962, 0.83770543, 0.74380326, 0.803439, 0.7695284, 0.77132225, 0.7874635, 0.7310244, 0.79554266, 0.6870464, 0.7935522, 0.6239426, 0.7874363, 0.54506314, 0.76332474, 0.6747651, 0.758849, 0.727136, 0.76293755, 0.764761, 0.75989854, 0.8223157, 0.7418668, 0.7667237, 0.74716485, 0.7290119, 0.7514565, 0.6860322, 0.75148356}},
		{Coords: []float32{0.020935707, 0.32654488, 0.017978385, 0.44575205, 0.03730628, 0.55777615, 0.06287024, 0.65922564, 0.09398955, 0.77242786, 0.13255802, 0.8584726, 0.17619722, 0.91629755, 0.23288493, 0.97306657, 0.35935226, 1.0131001, 0.5070362, 0.9768612, 0.6301788, 0.91984093, 0.72754556, 0.85714996, 0.8132125, 0.7618459, 0.8718368, 0.64610636, 0.90407705, 0.53842264, 0.9337987, 0.4217944, 0.9492372, 0.29229093, 0.030338392, 0.17774035, 0.05686575, 0.13015874, 0.10534899, 0.107641116, 0.15974997, 0.10773194, 0.21045813, 0.122945905, 0.4444515, 0.12218795, 0.5064329, 0.10467813, 0.5840114, 0.09778696, 0.671213, 0.11538686, 0.74866086, 0.16162129, 0.31396, 0.28022042, 0.28782278, 0.36707923, 0.2618948, 0.4489557, 0.25577158, 0.52268887, 0.2370641, 0.58098596, 0.25896645, 0.5954834, 0.29700103, 0.6018226, 0.34642577, 0.5893807, 0.38921297, 0.58004194, 0.106031395, 0.2717813, 0.12868103, 0.25398403, 0.18574017, 0.25014812, 0.2438463, 0.28059638, 0.19154847, 0.3002505, 0.13551968, 0.2975141, 0.4793697, 0.27299413, 0.5293588, 0.23735015, 0.5898527, 0.23711827, 0.64604825, 0.26580954, 0.5925545, 0.29003188, 0.52744645, 0.2858623, 0.17295486, 0.75070226, 0.20466802, 0.72201216, 0.26081702, 0.69991666, 0.3016228, 0.7072881, 0.3366254, 0.6944233, 0.43319604, 0.7199545, 0.52586204, 0.74377257, 0.4404627, 0.7921077, 0.3747536, 0.8176068, 0.31144354, 0.82792646, 0.2612812, 0.8223504, 0.21350484, 0.8011955, 0.18241839, 0.7503226, 0.25896072, 0.7420174, 0.3087325, 0.7380421, 0.36668938, 0.7404121, 0.51062566, 0.74222755, 0.37100863, 0.7624521, 0.31428868, 0.77023995, 0.2653185, 0.7681024}},
	},
	"gab.png-2": []*Landmarks{
		{Coords: []float32{0.1637706, 0.45305377, 0.17697525, 0.5352422, 0.1973823, 0.61464477, 0.2177997, 0.67491174, 0.25123274, 0.7401756, 0.30683705, 0.7808273, 0.379552, 0.8018528, 0.4522929, 0.8499511, 0.5389853, 0.86968595, 0.6318704, 0.8588923, 0.67522407, 0.82900506, 0.7171424, 0.806882, 0.7571322, 0.74484396, 0.79471177, 0.6791005, 0.8065007, 0.61166084, 0.8182926, 0.5335866, 0.81923115, 0.45582655, 0.25527763, 0.40021074, 0.3096544, 0.39034373, 0.36947042, 0.38361406, 0.41392356, 0.38504574, 0.45905498, 0.39705342, 0.6009091, 0.3904571, 0.6489139, 0.38249803, 0.6923059, 0.37874585, 0.73647743, 0.39389962, 0.7712939, 0.40518427, 0.5368468, 0.45976168, 0.5476006, 0.5078944, 0.5517063, 0.5481446, 0.5501776, 0.59543264, 0.48766974, 0.6176375, 0.51617396, 0.62568074, 0.5459643, 0.63441545, 0.5748922, 0.6240708, 0.59360313, 0.62292755, 0.33563095, 0.4538859, 0.36863104, 0.44470274, 0.4140095, 0.442721, 0.44167095, 0.4547676, 0.41731334, 0.47127298, 0.37188178, 0.47059065, 0.6095458, 0.45773804, 0.6517389, 0.44078976, 0.693595, 0.44120514, 0.71635795, 0.45268178, 0.6930264, 0.468964, 0.65160644, 0.46452644, 0.42536333, 0.6958598, 0.47041273, 0.6836382, 0.5260586, 0.6776929, 0.54730964, 0.6800253, 0.5730229, 0.6755983, 0.61814964, 0.68703634, 0.6540579, 0.7104722, 0.614673, 0.73742425, 0.57770544, 0.75972223, 0.5396347, 0.76355857, 0.507494, 0.7535774, 0.46701115, 0.73977524, 0.43239683, 0.70316535, 0.50754064, 0.69528973, 0.5423833, 0.7008082, 0.5758953, 0.69585806, 0.637876, 0.7104553, 0.5789893, 0.7340102, 0.5449631, 0.73293406, 0.510496, 0.72501737}},
	},
	"syl.png": []*Landmarks{
		{Coords: []float32{0.17564748, 0.34802938, 0.17777759, 0.4366538, 0.18807289, 0.5192348, 0.20451984, 0.58948356, 0.23421252, 0.6651486, 0.2858656, 0.71721524, 0.35464972, 0.7521936, 0.43544343, 0.79139614, 0.5313689, 0.81759125, 0.62048376, 0.80855215, 0.66597056, 0.78284633, 0.7122051, 0.75787205, 0.752201, 0.7054131, 0.7903427, 0.6370628, 0.80819356, 0.5681728, 0.8216734, 0.4984383, 0.8266353, 0.4249145, 0.3080901, 0.27898103, 0.36291587, 0.26090953, 0.4221179, 0.25493917, 0.47061718, 0.2624554, 0.51591396, 0.28123772, 0.65573424, 0.30070263, 0.69724226, 0.29404134, 0.7381246, 0.29709294, 0.7817578, 0.3126373, 0.8078706, 0.34052706, 0.5806999, 0.3632452, 0.5850833, 0.4096276, 0.59183234, 0.45240468, 0.5895888, 0.49930403, 0.51382184, 0.5310238, 0.54268885, 0.5399292, 0.573042, 0.54949, 0.6014007, 0.54386795, 0.624326, 0.54264843, 0.3732877, 0.3385805, 0.41132742, 0.33097336, 0.45259485, 0.33316183, 0.48109755, 0.3564068, 0.4540202, 0.36475623, 0.4096514, 0.35706514, 0.64400333, 0.37836128, 0.6829011, 0.36216575, 0.7253332, 0.37033165, 0.744551, 0.390049, 0.71883833, 0.39815348, 0.6798143, 0.38987496, 0.42237556, 0.61726195, 0.48173404, 0.600461, 0.5425831, 0.59428704, 0.5680201, 0.6015647, 0.5945405, 0.5990464, 0.63910556, 0.62385076, 0.6689116, 0.6522173, 0.6281488, 0.66739964, 0.5955696, 0.6760687, 0.55603886, 0.6764316, 0.51908857, 0.6673578, 0.47685325, 0.6510372, 0.43292737, 0.6202015, 0.52361745, 0.61823815, 0.5623267, 0.62628806, 0.5957942, 0.6299472, 0.65514594, 0.6477518, 0.59667265, 0.6421335, 0.5618354, 0.63782495, 0.5260191, 0.63185143}},
	},
}
